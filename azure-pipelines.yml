trigger:
- main

variables:
  acrLoginServer: bulkpaymentrcg.azurecr.io
  resourceGroup: bulkpayment-rcg-ks-dev
  aksCluster: bulkpayment-kbs-cl1

  apiImageName: bulkpayment-api
  processorImageName: payment-processor

# AGENT POOL (SELF-HOSTED)
pool:
  name: bulkpaymentagentpool

# BUILD STAGE
stages:
- stage: Build
  displayName: Build and Push Docker Images
  jobs:
  - job: BuildImages
    displayName: Build Images
    steps:
    - checkout: self

    # Build & push API image
    - task: Docker@2
      displayName: Build and Push API Image
      inputs:
        containerRegistry: bulkpaymentrcg-acr-connection
        repository: $(apiImageName)
        command: buildAndPush
        Dockerfile: BulkPaymentServer.Api/Dockerfile
        buildContext: .
        tags: |
          $(Build.BuildId)

    # Build & push Processor image
    - task: Docker@2
      displayName: Build and Push Processor Image
      inputs:
        containerRegistry: bulkpaymentrcg-acr-connection
        repository: $(processorImageName)
        command: buildAndPush
        Dockerfile: PaymentProcessor.Python/Dockerfile
        tags: |
          $(Build.BuildId)

# DEPLOY STAGE
- stage: Deploy
  displayName: Deploy to AKS
  dependsOn: Build
  jobs:
  - job: DeployToAKS
    displayName: Deploy workloads
    steps:
    - checkout: self

    # Login to AKS (Azure Resource Manager connection)
    - task: Kubernetes@1
      displayName: Login to AKS
      inputs:
        connectionType: Azure Resource Manager
        azureSubscriptionEndpoint: bulkpaymentrcg-aks-connection
        azureResourceGroup: $(resourceGroup)
        kubernetesCluster: $(aksCluster)
        command: login

    # Delete API Service (clean old invalid ports)
    - task: Kubernetes@1
      displayName: Delete API Service (if exists)
      inputs:
        connectionType: Kubernetes Service Connection
        kubernetesServiceEndpoint: bulkpaymentrcg-aks-k8s
        command: delete
        arguments: service bulkpayment-api --ignore-not-found
        namespace: default

    # Deploy API (Kubernetes service connection)
    - task: KubernetesManifest@1
      displayName: Deploy API
      inputs:
        action: deploy
        kubernetesServiceConnection: bulkpaymentrcg-aks-k8s
        manifests: |
          k8s/api-deployment.yaml
          k8s/api-service.yaml
        containers: |
          $(acrLoginServer)/$(apiImageName):$(Build.BuildId)

    # Deploy Processor (main)
    - task: KubernetesManifest@1
      displayName: Deploy Processor Main
      inputs:
        action: deploy
        kubernetesServiceConnection: bulkpaymentrcg-aks-k8s
        manifests: |
          k8s/processor-main-deployment.yaml
        containers: |
          $(acrLoginServer)/$(processorImageName):$(Build.BuildId)

    # Deploy Processor (retry)
    - task: KubernetesManifest@1
      displayName: Deploy Processor Retry
      inputs:
        action: deploy
        kubernetesServiceConnection: bulkpaymentrcg-aks-k8s
        manifests: |
          k8s/processor-retry-deployment.yaml
        containers: |
          $(acrLoginServer)/$(processorImageName):$(Build.BuildId)
